# Прототип микросервиса, обеспечивающий эмуляцию отправки сообщений в популярные месседжеры (Viber, Telegram, WhatsApp)

Используются rails 4.2.8 и ruby 2.4.5. В качестве воркера используется sidekiq. В качестве платформы для быстрого разворачивания проекта было решено использовать http://github.com/fs/rails-base-api

### API

Документация с примерами находится тут [http://localhost:3000/docs](http://localhost:3000/docs)

### Scripts

* `bin/setup` - первичная установка проекта
* `bin/rails s` - запуск сервера
* `bundle exec sidekiq` - запуск воркера
* `bin/rspec` - запуск тестов

### Пояснительная записка
- "Исключение возможности многократной отправки одного и того же сообщения (с одним и тем же содержимым) одному получателю" - в текущей реализации я добавил проверку уникальности сообщения в связке "{username}:{provider}:{message}", т.е. одному пользователю нельзя 2 раза отправить одно и то же сообщение в тот же мессенджер (но можно в другой). Если в задании имелось ввиду другое, то понадобится доработка.
- В текущей реализации порядок доставки не гарантируется. Т.е. если по какой-то причине второе сообщение обработалось быстрее (н-р, первый ушёл в ретрай и т.д.), то второе сообщение будет доставлено раньше.
- Нельзя гарантировать отсутсвие дубликатов без доп. поддержки со стороны мессенджера. Представим ситуацию, что мы отправили сообщение в мессенджер, мессенджер его обработал успешно, но из-за проблема сети мы словили тайм-аут и ушли на ретрай - получили дубликат.
- В текущей реализации отправка каждого сообщения выполняется по-одному. При необходимости можно реализовать вариант отправки пачками.
- Для получения большей устойчивости было принято решение хранить сообщения в БД (postgresql), а обработку очереди выполнять через sidekiq. Даже если sidekiq упадёт при запуске он разберёт очередь из БД. Запрос по api сохраняет сообщения в очередь, а воркер с интервалом в 10 секунд обходит очередь и отправляет сообщения в мессенджеры. Мессенджеры в свою очередь рандомно проходят/падают, эмулируя нестабильную работу. Сообщения об успехе или ошибке отображаются в логах sidekiq

### TODO
- таблицу `user_messages` нужно переименовать в `messages`, а колонку `message` в `body`
- нужно отладить и протестировать обработку входящего парамтера `send_at`
- нужно отладить и протестировать работу счётчика `retries_count`
- добавить локинг в БД, а не надеятся только на валидацию модели
